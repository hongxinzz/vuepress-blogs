#  å‰ç«¯è·¨åŸŸçš„é‚£äº›äº‹
## ä»€ä¹ˆæ˜¯åŒæºç­–ç•¥
åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œç»å¸¸ç¢°åˆ°ä¸€äº›è·¨åŸŸçš„é—®é¢˜ã€‚

ä¾‹å¦‚`www.a.com`æƒ³è¦è·å–åˆ°`www.b.com`çš„æ¥å£æˆ–è€…æ•°æ®ã€‚å°±ä¼šå› ä¸ºåŒæºç­–ç•¥çš„åŸå› è€Œæ— æ³•è·å–åˆ°ã€‚
> åŒæºç­–ç•¥ same-orgin policy
> **ä¸åŒåŸŸ**çš„å®¢æˆ·ç«¯è„šæœ¬åœ¨æ²¡æœ‰æ˜ç¡®**æˆæƒ**çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½è¯»å†™å¯¹æ–¹çš„èµ„æºã€‚

### ä¸¾ä¾‹
http://a.taobao.com

| åœ°å€ | æ˜¯å¦å¯ä»¥è¯·æ±‚ |
| :-------- | --------:| 
| https://a.taobao.com | ä¸å¯ä»¥-åè®®ä¸åŒ |
| http://www.taobao.com | ä¸å¯ä»¥-å­åŸŸä¸åŒ | 
| http://taobao.com |ä¸å¯ä»¥-å­åŸŸä¸åŒ |
| http://a.taobao.com:8080 | ä¸å¯ä»¥-ç«¯å£ä¸åŒ |
| http://a.taobao.com/music/ | å¯ä»¥-åŒåŸŸ |

##  CORSè·¨åŸŸ

CORSæ˜¯ä¸€ç§è·¨åŸŸçš„è§£å†³æ–¹æ¡ˆï¼Œå…¶åŸç†å°±æ˜¯å‰å°å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè€ŒæœåŠ¡å™¨å°±è¿”å›ä¸€ä¸ªè¯·æ±‚å¤´æˆæƒè®¿é—®ã€‚


![è¯·æ±‚ç¤ºä¾‹](/img/cros.jpg)

* å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªè·¨åŸŸçš„æ¥å£(**é»˜è®¤å¸¦æœ‰Originè¯·æ±‚å¤´**)
* æœåŠ¡ç«¯æ”¶åˆ°åè®¾ç½®ä¸€ä¸ªå“åº”å¤´å¹¶è¿”å›(**Access-Control-Allow-Origin**)**æˆæƒ**

```js
// åå°koaè„šæœ¬
const koa = require('koa');
const bodyParser = require('koa-bodyparser');
const app = new koa();

//ä½¿ç”¨bodyParser
app.use(bodyParser());

app.use(async ctx =>{
    const url = ctx.url;

    if(ctx.headers.origin && ctx.query.cors){
    //è®¾ç½®è¯·æ±‚å¤´
        ctx.set('Access-Control-Allow-origin',ctx.headers.origin)
    }
    let res = {
        code:0,
        data:'success'
    }
    ctx.body = JSON.stringify(res);
})

app.listen(3000,()=>{
    console.log('æœåŠ¡å™¨å†²èµ·æ¥äº†');
})
```
> åå°åœ¨`node` 3000çš„ç«¯å£è¿è¡Œï¼Œå‰å°åœ¨`http-server` 3001 ç«¯å£è¿è¡Œ

```js
//å‰å°è¯·æ±‚
  var $ = (id) => document.getElementById(id);
    var btn = $('button1');
    var btn2 = $('button2');
    function getData(callback, cors) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4 && xhr.responseText) {
                callback(JSON.parse(xhr.responseText), xhr);
            }
        }
        xhr.open('get', `http://127.0.0.1:3000/${cors}`);
        xhr.send(null);
    }
    btn.addEventListener('click', () => {
        getData((response) => {
            console.log(`${response.data}`)
        }, '');
    });
    btn2.addEventListener('click', () => {
        getData((response) => {
           console.log(`${response.data}`)
        }, '?cors=1');
    });

```



![](/img/crostest.gif)

* CORS ä¼˜ç‚¹åœ¨äºæ–¹ä¾¿ç®€æ´ï¼Œåªéœ€è¦æœåŠ¡ç«¯è®¾ç½®å“åº”å¤´å°±å¥½äº†ã€‚
* ç¼ºç‚¹åœ¨ä¸ä¸€äº›IEä¸å…¼å®¹ å…·ä½“å¯ä»¥çœ‹ ğŸ‘‰ [CORSå…¼å®¹æ€§](https://caniuse.com/#search=CORS)

##  JSONPè·¨åŸŸ
åŸç†
* é€šè¿‡ `script`è¿›è¡Œè¯·æ±‚é€šè¿‡srcè¯·æ±‚
* åˆ›å»ºä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç„¶ååœ¨è¿œç¨‹æœåŠ¡ä¸Šè°ƒç”¨è¿™ä¸ªå‡½æ•°å¹¶ä¸”å°†JSON æ•°æ®å½¢å¼ä½œä¸ºå‚æ•°ä¼ é€’
* å°†JSONæ•°æ®å¡«å……è¿›å›è°ƒå‡½æ•°

```js
//koa
const Koa = require('koa')
const bodyParser = require('koa-bodyparser')
const app = new Koa()
// ä½¿ç”¨bodyParser 
app.use(bodyParser())

app.use(async ctx => {
  const url = ctx.url
  if (url.indexOf('/getData') === 0) { // æ¥å£åç§°
    ctx.set('Content-Type', 'application/x-javascript')
    let res = {
        code:0,
        data:"æˆ‘æ˜¯ä¸€ä¸ªjsonPè·¨åŸŸçš„æ•°æ®ï¼"
    }
    ctx.body = `${ctx.query.callback || 'jsonp'}(${JSON.stringify(res)})`
  } else {
    ctx.status = 404
    ctx.body = '404'
  }
})
app.listen(3000, () => {
  console.log('æœåŠ¡å¯åŠ¨ï¼Œæ‰“å¼€ http://127.0.0.1:3000/')
})
```
> åå°åœ¨`node` 3000çš„ç«¯å£è¿è¡Œï¼Œå‰å°åœ¨`http-server` 8081 ç«¯å£è¿è¡Œ

```js
/**
 * è‡ªåŠ¨å‘é€ jsonp
 * @param {String} url
 * @param {Obj} data
 * @param {Function} callback
 */
function jsonp (url, data, callback) {
    var funcName = getFunctionName()
    data = data || {}
    data.callback = funcName
    url = parseUrl(url, serialize(data))
  
    window[funcName] = function (response) {
      // è¿™é‡Œå¯ä»¥çœ‹æƒ…å†µå¤„ç†ï¼Œæ¯”å¦‚å¦‚æœæ˜¯ jsonp æˆ‘ä»¬å¯ä»¥ parse ä¸€ä¸‹
      // data = JSON.parse(response)
      callback(response)
    }
  
    createScript(url)
  }
  /**
   * åºåˆ—åŒ–å‚æ•°
   * jsonp ä¸­å‚æ•°åªèƒ½æ˜¯ GET æ–¹å¼ä¼ é€’
   * @param {Obj} data
   */
  function serialize (data) {
    var ret = []
  
    Object.keys(data).forEach(item => {
      ret.push(encodeURIComponent(item) + '=' + encodeURIComponent(data[item]))
    })
  
    return ret.join('&')
  }
  
  /**
   * å¤„ç† URL ï¼ŒæŠŠå‚æ•°æ‹¼ä¸Šæ¥
   * @param {String} url
   * @param {String} param
   */
  function parseUrl (url, param) {
    return url + (url.indexOf('?') === -1 ? '?' : '&') + param
  }
  
  /**
   * å¿…é¡»è¦æœ‰ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œè€Œä¸”ä¸èƒ½é‡å
   */
  function getFunctionName () {
    return ('jsonp_' + Math.random()).replace('.', '')
  }
  
  /**
   * åˆ›å»º script æ ‡ç­¾å¹¶æ’åˆ° body ä¸­
   * @param {String} url
   */
  function createScript (url) {
    var doc = document
    var script = doc.createElement('script')
    script.src = url
    doc.body.appendChild(script)
  }
```

```js
//è°ƒç”¨
jsonp('http://127.0.0.1:3000/getData', {id:1}, (data) => {
    console.log(data)
})

```
![jsonPå®ç°æ•ˆæœ](/img/jsonptest.gif)

> è¿™æ˜¯ä¸€ä¸ªç®€å•ç‰ˆçš„`jsonP`çš„å®ç°ï¼Œé¢è¯•ä¸­ä¹Ÿä¼šå¸¸å¸¸è¢«é—®åˆ°ï¼Œå¹¶ä¸”æ‰‹æ’¸ä¸€ä¸ª`jsonP`

> å…·ä½“çš„ä¸€ä¸ªæ–¹æ³•å®ç°æ¨èä¸€ä¸ª github ä¸Šé¢çš„ä¸€ä¸ªåº“ ğŸ‘‰ [å®ç°jsonP](https://github.com/webmodules/jsonp/blob/master/index.js)

##  IFRAMEè·¨åŸŸ
åŸç†
* å€ŸåŠ©iframeæ ‡ç­¾è¿›è¡Œè·¨åŸŸ
* å°†è·å–åˆ°çš„æ•°æ®æŒ‚è½½åˆ°window.name

æˆ‘ä»¬ä»¥ä¸‰ä¸ªé¡µé¢ä¸ºä¾‹å’Œä¸€ä¸ªjsonä¸ºä¾‹
* a.html -> åœ¨ç«¯å£ 3001 è¿è¡Œ
* b.html -> åœ¨ç«¯å£ 3002 è¿è¡Œ
* c.html
* data.json
* cå»å»æ‰ç”¨çˆ¶çº§çš„æ–¹æ³•ï¼Œå¹¶ä¼ é€’è·å–åˆ°çš„æ•°æ®ã€‚

å¤§æ¦‚çš„äº¤äº’å›¾ä¸ºè¿™æ · ğŸ‘‡
![äº¤äº’å›¾](/img/iframe.jpg)

aä¸ºè¯·æ±‚æ•°æ®
```html
<!--a.html-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>æˆ‘æ˜¯Aé¡µé¢</title>
</head>

<body>
    <div></div>
    <script>
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4) {
                console.log(xhr.responseText);
            } else {
                console.log(xhr.status, xhr.statusText);
            }
        }
        xhr.open('get', 'http://127.0.0.1:3002/data.json');
        xhr.send(null);
    </script>
</body>
</html>
```
bä¸ºå¤„ç†æ•°æ®
```html
<!--b.html-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>å¤„ç†æ•°æ®</title>
</head>
<body>
  <script>
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        window.name = xhr.responseText;
        location.href = 'http://127.0.0.1:3001/c.html';
      } else {
        console.log(xhr.status, xhr.statusText);
      }
    }
    xhr.open('get', 'data.json');
    xhr.send(null);
  </script>
</body>
</html>
```
cä¸ºæ›´æ–°æ•°æ®
```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>ä¼ é€’æ•°æ®</title>
</head>
<body>
  <script>
    parent.update(window.name);
  </script>
</body>
</html>
```
dataæ•°æ®
```json
[
    {
        "data": "æˆ‘æ˜¯ä¸€æ¡è·¨åŸŸæ•°æ®"
    }
]
```

å½“æˆ‘ä»¬è°ƒç”¨a.htmlç¬¬ä¸€ä¸ªAJAXæ–¹æ³•çš„æ—¶å€™ï¼Œæ¯«æ— ç–‘é—®è‚¯å®šæ˜¯è·¨åŸŸçš„ï¼Œå› ä¸ºç«¯å£ä¸ä¸€æ ·
> Access to XMLHttpRequest at 'http://127.0.0.1:3002/data.json' from origin 'http://127.0.0.1:3001' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.


![ajax-error](/img/error.jpg)

æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹A çš„ä»£ç 

``` html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>æˆ‘æ˜¯Aé¡µé¢</title>
</head>

<body>
    <div></div>
    <iframe src="http://127.0.0.1:3002/b.html" frameborder="0"></iframe>
    <script>
        function update(data) {
            data = JSON.parse(data);
            var html = ['<ul>'];
            html.push(`<li>${data[0].data}</li>`);
            html.push('</ul>');
            document.querySelector('div').innerHTML = html.join('');
        }
    </script>
</body>
</html>
```
åœ¨æ”¹å˜äº†é€»è¾‘æ—¶
* `a.html` åµŒå¥—äº†ä¸€ä¸ªä¸æ¥å£ä¸€æ ·ç«¯å£çš„ç½‘é¡µ
* `b.html` é€šè¿‡åŒç«¯å£çš„æ–¹å¼è¯·æ±‚åˆ°äº†æƒ³ç”¨ç«¯å£çš„æ•°æ®ï¼Œå¹¶ä¸”æŒ‚è½½åˆ°äº†å…¨å±€çš„`window.name`ä¸Šï¼Œå¹¶ä¸”è·³è½¬åˆ°`c.html`
* `c.html` é€šè¿‡`parent`è°ƒç”¨`a.html`çš„`update`çš„æ–¹æ³•å¹¶æŠŠ`window.name`å€¼ä¸€åŒä¼ é€’

æ­¤æ—¶æˆ‘ä»¬å°±å¤§åŠŸå‘Šæˆå•¦,é¡µé¢æ˜¾ç¤ºå‡º`data.json`çš„æ•°æ®

![](/img/iframetest.jpg)


****


